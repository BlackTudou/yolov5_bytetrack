# 系统架构文档

## 1. 系统概述

**项目名称**：工厂人员安全距离监测与预警系统
**技术栈**：YOLOv5s + ByteTrack + OpenCV + PyTorch
**主要功能**：实时检测人员、跟踪轨迹、计算距离、检测违规

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Safety Distance Monitor                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌──────────────┐    ┌──────────────────┐ │
│  │  主程序     │───▶│  YOLOv5s     │───▶│  人体检测        │ │
│  │  main.py    │    │  检测器      │    │  (检测框+置信度)  │ │
│  └─────────────┘    └──────────────┘    └──────────────────┘ │
│         │                                                       │
│         ├─────────────────┐                                   │
│         │                 │                                   │
│         ▼                 ▼                                   │
│  ┌─────────────┐    ┌──────────────┐                         │
│  │ ByteTrack    │    │  距离计算    │                         │
│  │  跟踪器      │    │  与标定      │                         │
│  └─────────────┘    └──────────────┘                         │
│         │                 │                                   │
│         │                 │                                   │
│         └────────┬────────┘                                   │
│                  ▼                                            │
│         ┌─────────────────┐                                   │
│         │  违规检测       │                                   │
│         │  与可视化       │                                   │
│         └─────────────────┘                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 核心模块

### 3.1 主程序模块 (main.py)

**职责**：
- 初始化所有组件
- 管理视频流输入/输出
- 协调检测、跟踪、距离计算流程
- 处理和显示结果

**核心类**：`SafetyDistanceMonitor`

### 3.2 检测模块 (detection.py)

**职责**：
- 加载 YOLOv5s 模型
- 预处理图像（resize, normalize）
- 执行推理
- 解析检测结果（bounding box + confidence）

**核心类**：`YOLOv5Detector`

**输入**：原始图像（BGR格式）
**输出**：`[[tlwh, score, class_id], ...]`

### 3.3 跟踪模块 (tracker.py)

**职责**：
- ByteTrack 多目标跟踪算法
- 跨帧轨迹关联
- 处理遮挡、消失、重现

**核心类**：`ByteTracker`, `STrack`

**输入**：检测结果列表
**输出**：跟踪对象列表（带唯一ID）

### 3.4 标定模块 (camera_calibrate.py)

**职责**：
- 估算人员与相机的距离
- 将像素距离转换为真实距离
- 相机参数管理

**核心类**：`CameraCalibrator`

**核心方法**：
- `estimate_distance()`: 估算人员深度
- `pixel_to_real_distance()`: 像素→真实距离转换

## 4. 数据流

### 4.1 主流程数据流

```
视频帧
  ↓
[YOLOv5s检测] → 检测结果 (bbox, score, class)
  ↓
[ByteTrack跟踪] → 跟踪对象 (bbox, track_id)
  ↓
[距离计算] → 两人间真实距离
  ↓
[违规检测] → 小于阈值的距离对
  ↓
[可视化] → 标注、连线、显示
```

### 4.2 跟踪数据流

```
新检测 → 高置信度检测 → [匹配已跟踪] → 更新轨迹
                         ↓ 未匹配    → [新轨迹]
                         ↓
                低置信度检测 → [关联丢失轨迹] → 重新激活
```

## 5. 关键数据结构

### 5.1 检测结果
```python
detection = [
    [x, y, w, h],  # tlwh格式：左上角坐标+宽高
    confidence,     # 置信度 (0-1)
    class_id       # 类别ID (0=person)
]
```

### 5.2 跟踪对象
```python
class STrack:
    tlwh: [x, y, w, h]  # 边界框
    track_id: int       # 唯一ID
    score: float        # 置信度
    state: str          # 'Tracked'/'Lost'/'Removed'
    mean: [x, y, w, h]  # 卡尔曼滤波状态
```

### 5.3 违规信息
```python
violation = (id1, id2, real_distance)
# (person1的track_id, person2的track_id, 真实距离米)
```

## 6. 关键技术细节

### 6.1 模型加载策略
```python
# 1. 尝试加载本地模型（权重）
# 2. 如果失败，从torch.hub下载
# 3. 兼容 PyTorch 2.6+ (weights_only=False)
```

### 6.2 ByteTrack 核心算法
- **关联机制**：IoU距离+匈牙利算法
- **状态管理**：Tracked → Lost → Removed
- **关联策略**：
  - 高置信度检测 ↔ 已跟踪轨迹
  - 高置信度检测 ↔ 丢失轨迹（重新激活）
  - 低置信度检测 ↔ 丢失轨迹

### 6.3 距离估算方法
```python
# 步骤1：估算每个人与相机的距离
distance = (已知物体大小 × 焦距) / 像素大小

# 步骤2：计算两人间的像素距离
pixel_dist = sqrt((x1-x2)² + (y1-y2)²)

# 步骤3：转换为真实距离
real_dist = (pixel_dist / 焦距) × 平均深度
```

## 7. 性能优化

### 7.1 检测优化
- 自适应焦距（根据视频分辨率）
- 加权平均（高度70%+宽度30%）
- 透视校正

### 7.2 跟踪优化
- IoU缓存
- 只处理激活的轨迹
- 限制轨迹缓冲区大小

### 7.3 显示优化
- 每30帧保存一次图片
- 实时FPS计算
- 警告频率限制（2秒一次）

