# 像素距离到真实世界距离的映射原理

## 基本原理

当前系统使用一个简化的距离估计算法，基于以下假设：

### 1. 透视投影原理
真实世界中物体的大小和距离的关系：
```
真实大小 = (像素大小 × 真实距离) / 焦距
```

或者反过来：
```
真实距离 = (已知物体真实大小 × 焦距) / 像素大小
```

### 2. 当前实现的方法

系统使用**两步骤**估算：

#### 步骤1：估算每个人与相机的距离
```python
# 基于人的宽度估算距离
distance_by_width = (known_real_width × focal_length) / pixel_width

# 基于人的高度估算距离
distance_by_height = (known_real_height × focal_length) / pixel_height

# 取平均值
estimated_distance = (distance_by_width + distance_by_height) / 2
```

其中：
- `known_real_width = 0.4m` (假设人的肩膀宽度)
- `known_real_height = 1.7m` (假设人的平均身高)
- `focal_length = 800像素` (相机的焦距参数)

#### 步骤2：将像素距离转换为真实距离
```python
# 计算像素距离
pixel_distance = sqrt((x1-x2)² + (y1-y2)²)

# 转换为真实距离
angular_distance = pixel_distance / focal_length
real_distance = angular_distance × avg_distance_to_camera
```

## 当前系统的局限性

### ⚠️ 局限性
1. **使用固定参数**：假设人的标准身高1.7m，肩宽0.4m
2. **简化透视**：假设物体在同一平面（忽略了高度差）
3. **没有真正的相机标定**：使用估计的焦距值
4. **只计算水平距离**：忽略了垂直高度差

### 📏 距离准确度
- **误差范围**：±20-50%
- **适用场景**：预估值，不适合高精度测量
- **影响因素**：
  - 人员实际高度
  - 相机角度（俯视/平视/仰视）
  - 摄像头焦距
  - 人员与相机的距离

## 如何提高距离映射准确性

### 方法1：相机标定（推荐）
使用已知尺寸的参考物体标定相机：

```python
# 示例：在视频中放置一个1米×1米的标定板
# 测量它在视频中的像素大小
pixel_width = 500  # 标定板在视频中的像素宽度
real_width = 1.0   # 标定板的真实宽度（米）
actual_distance = 5.0  # 标定板距离相机的真实距离

# 计算真实焦距
focal_length = (pixel_width × actual_distance) / real_width
```

### 方法2：使用已知参考物体
如果视频中有已知大小的物体（如垃圾桶、护栏），可以用来校准：

1. 在视频中找到该物体
2. 测量物体的像素大小
3. 根据实际物体大小反推焦距

### 方法3：深度学习深度估计（高级）
使用单目深度估计模型（如MiDaS）：
- 可以估算每个像素的深度
- 需要更复杂的模型和计算

## 当前代码的改进方向

### 改进1：可配置的标定参数
```python
# 运行时可设置
python main.py \
    --focal-length 1200 \
    --person-height 1.65 \
    --person-width 0.45
```

### 改进2：使用透视变换
如果可以获取相机内参和外参：
- 计算真实世界坐标
- 考虑相机俯仰角
- 计算3D距离

### 改进3：集成深度估计
```python
# 使用深度估计模型
depth_model = midas()
depth_map = depth_model(frame)
real_distance = calculate_from_depth(depth_map)
```

## 不同场景的距离估算

### 俯视场景（最佳）
- ✅ 如果相机是俯视拍摄
- 平面视角，高度差影响小
- 距离估算相对准确

### 平视场景（一般）
- ⚠️ 如果相机是平视
- 需要考虑人物高度
- 远距离误差较大

### 仰视场景（较差）
- ❌ 如果相机是仰视
- 透视变形严重
- 距离估算不准确

## 实际使用建议

### 对于工厂车间
1. **使用俯视或较高角度**：减少高度差影响
2. **放置参考物体**：如固定尺寸的标志牌
3. **多次标定**：在不同场景测试
4. **保守阈值**：设置稍大的安全距离（如2.0m而不是1.5m）

### 对于建筑工地
1. **分层估算**：不同的相机高度有不同的焦距
2. **区域划分**：将场景分成多个区域，分别标定
3. **使用已知参考**：如脚手架间距、车辆尺寸等

### 对于办公室
1. **使用标准桌椅**：桌椅作为参考物
2. **固定相机位置**：每次部署时保持一致
3. **小范围测试**：先用真实测量验证

## 验证距离准确性

### 测试方法
1. 在场景中放置两个已知距离的标志点（如相距2米）
2. 运行系统测量它们之间的距离
3. 对比测量值和真实值
4. 调整参数直到误差可接受

### 公式调整
如果测量值总是偏大或偏小：
```python
# 测量值总是偏大（如测量1m显示为2m）
focal_length *= 2.0  # 增大焦距

# 测量值总是偏小（如测量1m显示为0.5m）
focal_length *= 0.5  # 减小焦距
```

## 总结

当前系统的距离映射：
- ✅ **适合定性分析**：判断人员是否过于接近
- ⚠️ **不适合定量测量**：精确到厘米级别的距离
- 📊 **适合预警目的**：检测安全距离违规
- 🔧 **需要实际标定**：获得更准确的结果

如果需要高精度测量，建议：
1. 使用双目立体视觉
2. 使用RGB-D相机（如Kinect）
3. 进行专业的相机标定
4. 使用LiDAR或ToF深度传感器

